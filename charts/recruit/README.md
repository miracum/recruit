# recruIT Helm Chart

![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square)

This chart deploys the recruIT clinical trial recruitment support system on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.

## Prerequisites

- Kubernetes v1.21+
- Helm v3.8+

## Upgrades & Breaking Changes

See [UPGRADING.md](./docs/UPGRADING.md) for information on breaking changes introduced by major version bumps and instructions on how to update.

## Sample usage

```sh
helm install recruit oci://ghcr.io/miracum/recruit/charts/recruit -n recruit
```

## Values

| Key                                               | Type   | Default                                                                                                                              | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------------------------------------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| broadseaAtlasdb.enabled                           | bool   | `false`                                                                                                                              | whether to deploy the OHDSI Broadsea Atlasdb (<https://github.com/OHDSI/Broadsea-Atlasdb>) currently only used by internal integration tests. See [./values-integrationtest.yaml](values-integrationtest.yaml)                                                                                                                                                                                                                                                     |
| deploymentAnnotations                             | object | `{}`                                                                                                                                 | annotations to set on all Deployment resources                                                                                                                                                                                                                                                                                                                                                                                                                     |
| externalFhirServer.url                            | string | `""`                                                                                                                                 | URL of an external FHIR Server - only used when `fhirserver.enabled` is set to `false`                                                                                                                                                                                                                                                                                                                                                                             |
| extraLabels                                       | object | `{}`                                                                                                                                 | additionally labels to apply to all deployments                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fhir-pseudonymizer                                | object | `{"enabled":false,"pseudonymizationService":"Vfps","vfps":{"enabled":true}}`                                                         | configuration for the optional fhir-pseudonymizer dependency                                                                                                                                                                                                                                                                                                                                                                                                       |
| fhir-pseudonymizer.enabled                        | bool   | `false`                                                                                                                              | install the included fhir-pseudonymizer chart. If set to `true`, the list module is auto-configured to use this service.                                                                                                                                                                                                                                                                                                                                           |
| fhir-pseudonymizer.pseudonymizationService        | string | `"Vfps"`                                                                                                                             | default to using Vfps as a pseudonym service. It is included as a dependency of the fhir-pseudonymizer.                                                                                                                                                                                                                                                                                                                                                            |
| fhir-pseudonymizer.vfps.enabled                   | bool   | `true`                                                                                                                               | enable the included Vfps service.                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fhirserver.enabled                                | bool   | `true`                                                                                                                               | Whether the included HAPI FHIR server should be used See <https://github.com/hapifhir/hapi-fhir-jpaserver-starter/tree/master/charts/hapi-fhir-jpaserver#values> for options.                                                                                                                                                                                                                                                                                      |
| fhirserver.extraEnv                               | list   | `[{"name":"HAPI_FHIR_SUBSCRIPTION_RESTHOOK_ENABLED","value":"true"},{"name":"SPRING_FLYWAY_BASELINE_ON_MIGRATE","value":"true"}]`    | extra environment variables set for the HAPI FHIR server                                                                                                                                                                                                                                                                                                                                                                                                           |
| fhirserver.networkPolicy.enabled                  | bool   | `false`                                                                                                                              | if enabled, access to the included FHIR server is limited to pods with the required labels. If set to `true`, all pods of the recruIT chart will be automatically configured to be able to access the server.                                                                                                                                                                                                                                                      |
| fhirserver.postgresql.nameOverride                | string | `"fhir-server-postgres"`                                                                                                             | overrides the chart's postgres server name to avoid conflicts with the included ohdsi chart                                                                                                                                                                                                                                                                                                                                                                        |
| fullnameOverride                                  | string | `""`                                                                                                                                 | fully override the release name                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| imagePullSecrets                                  | list   | `[]`                                                                                                                                 | image pull secrets used by all pods                                                                                                                                                                                                                                                                                                                                                                                                                                |
| list.affinity                                     | object | `{}`                                                                                                                                 | affinity for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>                                                                                                                                                                                                                                                                                                                                   |
| list.auth.enabled                                 | bool   | `false`                                                                                                                              | if enabled, requires authentication before accessing the screening list                                                                                                                                                                                                                                                                                                                                                                                            |
| list.auth.keycloak.clientId                       | string | `"uc1-screeninglist"`                                                                                                                | the Keycloak client id                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| list.auth.keycloak.realm                          | string | `"MIRACUM"`                                                                                                                          | the Keycloak realm                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| list.auth.keycloak.url                            | string | `"http://localhost:8083/auth"`                                                                                                       | the Keycloak auth URL. Should end in `/auth`.                                                                                                                                                                                                                                                                                                                                                                                                                      |
| list.dePseudonymization.apiKey                    | string | `""`                                                                                                                                 | the API key to invoke the FHIR pseudonymizer                                                                                                                                                                                                                                                                                                                                                                                                                       |
| list.dePseudonymization.enabled                   | bool   | `false`                                                                                                                              | if enabled, all FHIR resource will first be processed by the fhir-pseudonymizer for de-pseudonymization before being displayed.                                                                                                                                                                                                                                                                                                                                    |
| list.dePseudonymization.existingApiKeySecret      | object | `{"key":"fhir-pseudonymizer-api-key","name":""}`                                                                                     | use an existing Secret resource that contains the API key                                                                                                                                                                                                                                                                                                                                                                                                          |
| list.dePseudonymization.existingApiKeySecret.key  | string | `"fhir-pseudonymizer-api-key"`                                                                                                       | key of the Kubernetes Secret that contains the API key                                                                                                                                                                                                                                                                                                                                                                                                             |
| list.dePseudonymization.existingApiKeySecret.name | string | `""`                                                                                                                                 | name of an existing Kubernetes Secret that contains the API key. Leave empty to use `dePseudonymization.apiKey` instead.                                                                                                                                                                                                                                                                                                                                           |
| list.dePseudonymization.serviceUrl                | string | `"http://fhir-pseudonymizer:8080/fhir"`                                                                                              | API base URL of the FHIR pseudonymizer to use. If `fhir-pseudonymizer.enabled` is set to `true`, this URL will be auto-configured.                                                                                                                                                                                                                                                                                                                                 |
| list.enabled                                      | bool   | `true`                                                                                                                               | Whether the list module should be enabled                                                                                                                                                                                                                                                                                                                                                                                                                          |
| list.extraEnv                                     | list   | `[]`                                                                                                                                 | specify extra environment vars on the container                                                                                                                                                                                                                                                                                                                                                                                                                    |
| list.extraPodLabels                               | object | `{}`                                                                                                                                 | specify additional labels to apply to the list pod                                                                                                                                                                                                                                                                                                                                                                                                                 |
| list.ingress.annotations                          | object | `{}`                                                                                                                                 | additional annotations for the Ingress resource                                                                                                                                                                                                                                                                                                                                                                                                                    |
| list.ingress.enabled                              | bool   | `false`                                                                                                                              | if enabled, create an ingress resource to access the screening list                                                                                                                                                                                                                                                                                                                                                                                                |
| list.ingress.hosts[0].host                        | string | `"list.127.0.0.1.nip.io"`                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| list.ingress.hosts[0].paths[0]                    | string | `"/"`                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| list.ingress.ingressClassName                     | string | `""`                                                                                                                                 | name of the IngressClass resource to use for this ingress                                                                                                                                                                                                                                                                                                                                                                                                          |
| list.ingress.tls                                  | list   | `[]`                                                                                                                                 | TLS configuration                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| list.metrics.serviceMonitor.additionalLabels      | object | `{}`                                                                                                                                 | additional labels                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| list.metrics.serviceMonitor.enabled               | bool   | `false`                                                                                                                              | if enabled, creates a ServiceMonitor instance for Prometheus Operator-based monitoring                                                                                                                                                                                                                                                                                                                                                                             |
| list.nodeSelector                                 | object | `{}`                                                                                                                                 | node labels for pod assignment see: <https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/>                                                                                                                                                                                                                                                                                                                                                     |
| list.podDisruptionBudget.enabled                  | bool   | `false`                                                                                                                              | uses policy/v1 of the PodDisruptionBudget resource requiring Kubernetes 1.21+                                                                                                                                                                                                                                                                                                                                                                                      |
| list.podDisruptionBudget.maxUnavailable           | string | `""`                                                                                                                                 | Maximum unavailable instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                          |
| list.podDisruptionBudget.minAvailable             | int    | `1`                                                                                                                                  | Minimum available instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                            |
| list.podSecurityContext                           | object | `{}`                                                                                                                                 | security context for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| list.replicaCount                                 | int    | `1`                                                                                                                                  | Number of replicas for the list module. A fault-tolerant number of replicas is recommended.                                                                                                                                                                                                                                                                                                                                                                        |
| list.resources                                    | object | `{}`                                                                                                                                 | resource requests and limits for the container                                                                                                                                                                                                                                                                                                                                                                                                                     |
| list.revisionHistoryLimit                         | int    | `5`                                                                                                                                  | specify how many old ReplicaSets for this Deployment you want to retain.                                                                                                                                                                                                                                                                                                                                                                                           |
| list.service                                      | object | `{"port":8080,"type":"ClusterIP"}`                                                                                                   | the service used to expose the list module web port                                                                                                                                                                                                                                                                                                                                                                                                                |
| list.service.port                                 | int    | `8080`                                                                                                                               | service port                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| list.service.type                                 | string | `"ClusterIP"`                                                                                                                        | service type                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| list.tolerations                                  | list   | `[]`                                                                                                                                 | tolerations for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>                                                                                                                                                                                                                                                                                                                                                      |
| list.topologySpreadConstraints                    | list   | `[]`                                                                                                                                 | pod topology spread configuration see: <https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#api>                                                                                                                                                                                                                                                                                                                                   |
| mailhog.enabled                                   | bool   | `true`                                                                                                                               | Whether the included SMTP test server should be used. Not required for a production deployment. See <https://github.com/codecentric/helm-charts/blob/master/charts/mailhog/values.yaml> for available options.                                                                                                                                                                                                                                                     |
| nameOverride                                      | string | `""`                                                                                                                                 | partially override the release name                                                                                                                                                                                                                                                                                                                                                                                                                                |
| notify.affinity                                   | object | `{}`                                                                                                                                 | affinity for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>                                                                                                                                                                                                                                                                                                                                   |
| notify.enabled                                    | bool   | `true`                                                                                                                               | whether the notification module should be enabled                                                                                                                                                                                                                                                                                                                                                                                                                  |
| notify.extraEnv                                   | list   | `[]`                                                                                                                                 | extra environment vars on the container                                                                                                                                                                                                                                                                                                                                                                                                                            |
| notify.extraPodLabels                             | object | `{}`                                                                                                                                 | specify additional labels to apply to the notify pod                                                                                                                                                                                                                                                                                                                                                                                                               |
| notify.ha.database.existingSecret.key             | string | `"postgresql-password"`                                                                                                              | key inside the existing secret                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| notify.ha.database.existingSecret.name            | string | `""`                                                                                                                                 | name of an existing Kubernetes secret from which to retrieve the user's password.                                                                                                                                                                                                                                                                                                                                                                                  |
| notify.ha.database.host                           | string | `""`                                                                                                                                 | hostname for the database used to store notification jobs if `postgresql.enabled=true`, uses the included PostgreSQL database instead.                                                                                                                                                                                                                                                                                                                             |
| notify.ha.database.name                           | string | `"recruit_notify_jobstore"`                                                                                                          | database name                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| notify.ha.database.password                       | string | `""`                                                                                                                                 | password for the database                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| notify.ha.database.port                           | int    | `5432`                                                                                                                               | database port                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| notify.ha.database.username                       | string | `""`                                                                                                                                 | username to log into the database                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| notify.ha.enabled                                 | bool   | `false`                                                                                                                              | whether to enable high-availability mode for the notification module                                                                                                                                                                                                                                                                                                                                                                                               |
| notify.ingress.annotations                        | object | `{}`                                                                                                                                 | additional annotations for the Ingress resource                                                                                                                                                                                                                                                                                                                                                                                                                    |
| notify.ingress.enabled                            | bool   | `false`                                                                                                                              | if enabled, this ingress is used when setting up the webhook subscription in the FHIR server. Setting this ingress is useful if the FHIR server is external to the cluster and can only be reached via this ingress. The URL called by the external FHIR server with ingress enabled is as follows: "http(s)://ingress.hosts[0].host/on-list-change" If ingress.enabled is false, then the notify.service is used to construct the URL invoked by the FHIR server. |
| notify.ingress.hosts[0].host                      | string | `"notify.127.0.0.1.nip.io"`                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| notify.ingress.hosts[0].paths[0]                  | string | `"/"`                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| notify.ingress.ingressClassName                   | string | `""`                                                                                                                                 | name of the IngressClass resource to use for this ingress                                                                                                                                                                                                                                                                                                                                                                                                          |
| notify.ingress.tls                                | list   | `[]`                                                                                                                                 | TLS configuration                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| notify.mail.from                                  | string | `"recruit@example.com"`                                                                                                              | The sender email address for the created notification mails.                                                                                                                                                                                                                                                                                                                                                                                                       |
| notify.mail.screeningListLinkTemplate             | string | `"http://localhost:8080/recommendations/[list_id]"`                                                                                  | Used to link back to the screening list web app from an email. If the screening list ingress is enabled, it uses list.ingress.hosts.host to construct the URL, otherwise uses this value. Should include a '[list_id]' which is replaced with the internal screening list id.                                                                                                                                                                                      |
| notify.mail.server                                | object | `{"existingSecret":"","host":"","password":"","port":25,"username":""}`                                                              | configure the mail server used to send notification emails All of these values are only used when mailhog.enabled is set to false                                                                                                                                                                                                                                                                                                                                  |
| notify.mail.server.existingSecret                 | string | `""`                                                                                                                                 | Name of an existing secret containing an `smtp-password` key to use instead of the password value above                                                                                                                                                                                                                                                                                                                                                            |
| notify.mail.server.host                           | string | `""`                                                                                                                                 | hostname of the external SMTP mail server                                                                                                                                                                                                                                                                                                                                                                                                                          |
| notify.mail.server.password                       | string | `""`                                                                                                                                 | Mailserver password                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| notify.mail.server.port                           | int    | `25`                                                                                                                                 | mailserver port                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| notify.mail.server.username                       | string | `""`                                                                                                                                 | Mailserver username                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| notify.metrics.serviceMonitor.additionalLabels    | object | `{}`                                                                                                                                 | additional labels to set on the ServiceMonitor object, e.g. `release: prometheus-operator`                                                                                                                                                                                                                                                                                                                                                                         |
| notify.metrics.serviceMonitor.enabled             | bool   | `false`                                                                                                                              | if enabled, creates a ServiceMonitor instance for Prometheus Operator-based monitoring                                                                                                                                                                                                                                                                                                                                                                             |
| notify.nodeSelector                               | object | `{}`                                                                                                                                 | node labels for pod assignment see: <https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/>                                                                                                                                                                                                                                                                                                                                                     |
| notify.podDisruptionBudget.enabled                | bool   | `false`                                                                                                                              | enable creation of a PDB resource for the pod. Uses policy/v1 of the PodDisruptionBudget resource requiring Kubernetes 1.21+                                                                                                                                                                                                                                                                                                                                       |
| notify.podDisruptionBudget.maxUnavailable         | string | `""`                                                                                                                                 | Maximum unavailable instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                          |
| notify.podDisruptionBudget.minAvailable           | int    | `1`                                                                                                                                  | Minimum available instances; ignored if there is no PodDisruptionBudget                                                                                                                                                                                                                                                                                                                                                                                            |
| notify.podSecurityContext                         | object | `{}`                                                                                                                                 | security context for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| notify.replicaCount                               | int    | `1`                                                                                                                                  | number of replicas for the notify component. should only be set to a number > 1 if `notify.ha.enabled=true`                                                                                                                                                                                                                                                                                                                                                        |
| notify.resources                                  | object | `{}`                                                                                                                                 | resource requests and limits for the container                                                                                                                                                                                                                                                                                                                                                                                                                     |
| notify.revisionHistoryLimit                       | int    | `5`                                                                                                                                  | specify how many old ReplicaSets for this Deployment you want to retain.                                                                                                                                                                                                                                                                                                                                                                                           |
| notify.rules                                      | object | `{}`                                                                                                                                 | configure the Notification rules. See the [Configure Notifcation Rules](#configure-notifcation-rules) section below.                                                                                                                                                                                                                                                                                                                                               |
| notify.service                                    | object | `{"metricsPort":8081,"port":8080,"type":"ClusterIP"}`                                                                                | the service used to expose the notify module web port                                                                                                                                                                                                                                                                                                                                                                                                              |
| notify.service.metricsPort                        | int    | `8081`                                                                                                                               | service port for the actuator/metrics endpoint                                                                                                                                                                                                                                                                                                                                                                                                                     |
| notify.service.port                               | int    | `8080`                                                                                                                               | service port for the HTTP endpoint                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| notify.service.type                               | string | `"ClusterIP"`                                                                                                                        | service type                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| notify.tolerations                                | list   | `[]`                                                                                                                                 | tolerations for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>                                                                                                                                                                                                                                                                                                                                                      |
| notify.topologySpreadConstraints                  | list   | `[]`                                                                                                                                 | pod topology spread configuration see: <https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#api>                                                                                                                                                                                                                                                                                                                                   |
| ohdsi.cdmInitJob.enabled                          | bool   | `false`                                                                                                                              | to make sure the job runs only once, set this to `false` after the first installation completed                                                                                                                                                                                                                                                                                                                                                                    |
| ohdsi.enabled                                     | bool   | `true`                                                                                                                               | Whether the included OHDSI chart should be installed. See <https://github.com/chgl/charts/tree/master/charts/ohdsi/values.yaml> for available options.                                                                                                                                                                                                                                                                                                             |
| ohdsi.postgresql.nameOverride                     | string | `"ohdsi-postgres"`                                                                                                                   | overrides the chart's postgres server name to avoid conflicts with the included HAPI FHIR server chart                                                                                                                                                                                                                                                                                                                                                             |
| podAnnotations                                    | object | `{}`                                                                                                                                 | annotations to set on all Pod resources                                                                                                                                                                                                                                                                                                                                                                                                                            |
| postgresql.auth.database                          | string | `"recruit"`                                                                                                                          | set the default database name to `recruit`                                                                                                                                                                                                                                                                                                                                                                                                                         |
| postgresql.enabled                                | bool   | `false`                                                                                                                              | enable the included postgres DB, currently used only by the notification module to store jobs when running in high-availability mode (`notify.ha.enabled=true`)                                                                                                                                                                                                                                                                                                    |
| postgresql.nameOverride                           | string | `"recruit-postgres"`                                                                                                                 | override the default name to avoid conflicts with the HAPI and OHDSI charts                                                                                                                                                                                                                                                                                                                                                                                        |
| query.affinity                                    | object | `{}`                                                                                                                                 | affinity for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity>                                                                                                                                                                                                                                                                                                                                   |
| query.cohortSelectorLabels                        | list   | `["UC1"]`                                                                                                                            | set cohortSelectorLabels[1]=Test                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| query.enabled                                     | bool   | `true`                                                                                                                               | Whether the query module should be enabled                                                                                                                                                                                                                                                                                                                                                                                                                         |
| query.extraEnv                                    | list   | `[]`                                                                                                                                 | extra environment vars on the container                                                                                                                                                                                                                                                                                                                                                                                                                            |
| query.extraPodLabels                              | object | `{}`                                                                                                                                 | specify additional labels to apply to the query pod                                                                                                                                                                                                                                                                                                                                                                                                                |
| query.metrics.serviceMonitor.additionalLabels     | object | `{}`                                                                                                                                 | additional labels to apply the the ServiceMonitor object, eg. `release: prometheus`                                                                                                                                                                                                                                                                                                                                                                                |
| query.metrics.serviceMonitor.enabled              | bool   | `false`                                                                                                                              | if enabled, creates a ServiceMonitor instance for Prometheus Operator-based monitoring                                                                                                                                                                                                                                                                                                                                                                             |
| query.nodeSelector                                | object | `{}`                                                                                                                                 | node labels for pod assignment see: <https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/>                                                                                                                                                                                                                                                                                                                                                     |
| query.omop.cdmSchema                              | string | `"cds_cdm"`                                                                                                                          | name of the database schema containing the actual clinical data                                                                                                                                                                                                                                                                                                                                                                                                    |
| query.omop.database                               | string | `"OHDSI"`                                                                                                                            | name of the db                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| query.omop.existingSecret                         | string | `""`                                                                                                                                 | name of an existing secret to use instead of `omop.password`. Must include an `omop-password` key.                                                                                                                                                                                                                                                                                                                                                                 |
| query.omop.host                                   | string | `"localhost"`                                                                                                                        | hostname of the OHDSI OMOP db                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| query.omop.password                               | string | `"postgres"`                                                                                                                         | password to access the db                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| query.omop.port                                   | int    | `5432`                                                                                                                               | port of the db                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| query.omop.resultsSchema                          | string | `"cds_results"`                                                                                                                      | name of the database schema containing the results of the cohort generation                                                                                                                                                                                                                                                                                                                                                                                        |
| query.omop.username                               | string | `"postgres"`                                                                                                                         | username to access the db                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| query.podSecurityContext                          | object | `{}`                                                                                                                                 | security context for the pod                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| query.replicaCount                                | int    | `1`                                                                                                                                  | Number of replicas of the query module to run. Running more than one replica for this component is discouraged.                                                                                                                                                                                                                                                                                                                                                    |
| query.resources                                   | object | `{}`                                                                                                                                 | resource requests and limits for the container                                                                                                                                                                                                                                                                                                                                                                                                                     |
| query.revisionHistoryLimit                        | int    | `5`                                                                                                                                  | specify how many old ReplicaSets for this Deployment you want to retain.                                                                                                                                                                                                                                                                                                                                                                                           |
| query.schedule                                    | string | `"*/5 * * * *"`                                                                                                                      | a UNIX cron expression defining the execution schedule of the query module                                                                                                                                                                                                                                                                                                                                                                                         |
| query.service                                     | object | `{"metricsPort":8081,"port":8080,"type":"ClusterIP"}`                                                                                | the service used to expose the query module web port                                                                                                                                                                                                                                                                                                                                                                                                               |
| query.service.metricsPort                         | int    | `8081`                                                                                                                               | the service port for the actuator/metrics endpoint                                                                                                                                                                                                                                                                                                                                                                                                                 |
| query.service.port                                | int    | `8080`                                                                                                                               | the service port for the HTTP endpoint                                                                                                                                                                                                                                                                                                                                                                                                                             |
| query.service.type                                | string | `"ClusterIP"`                                                                                                                        | the service type                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| query.shouldWaitForNotify                         | bool   | `false`                                                                                                                              | whether the query module should wait for the notification module to be up before starting. implemented as an init container that waits on notify's `/actuator/health` endpoint                                                                                                                                                                                                                                                                                     |
| query.tolerations                                 | list   | `[]`                                                                                                                                 | tolerations for pod assignment see: <https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/>                                                                                                                                                                                                                                                                                                                                                      |
| query.topologySpreadConstraints                   | list   | `[]`                                                                                                                                 | pod topology spread configuration see: <https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#api>                                                                                                                                                                                                                                                                                                                                   |
| query.webAPI.auth                                 | object | `{"enabled":false,"existingSecret":{"key":"webApiAuthPassword","name":""},"loginPath":"/user/login/db","password":"","username":""}` | configure authentication settings for the WebAPI                                                                                                                                                                                                                                                                                                                                                                                                                   |
| query.webAPI.auth.enabled                         | bool   | `false`                                                                                                                              | set to true if the WebAPI requires authentication to access                                                                                                                                                                                                                                                                                                                                                                                                        |
| query.webAPI.auth.existingSecret                  | object | `{"key":"webApiAuthPassword","name":""}`                                                                                             | use an existing secret to retrieve the login credentials from                                                                                                                                                                                                                                                                                                                                                                                                      |
| query.webAPI.auth.existingSecret.key              | string | `"webApiAuthPassword"`                                                                                                               | the key containing the password                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| query.webAPI.auth.existingSecret.name             | string | `""`                                                                                                                                 | name of an existing Kubernetes secret that contains the user password                                                                                                                                                                                                                                                                                                                                                                                              |
| query.webAPI.auth.loginPath                       | string | `"/user/login/db"`                                                                                                                   | the login method/path to use. See <https://github.com/OHDSI/Atlas/blob/master/js/config/app.js#L20> for a list of possible values                                                                                                                                                                                                                                                                                                                                  |
| query.webAPI.auth.password                        | string | `""`                                                                                                                                 | the password used for login.                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| query.webAPI.auth.username                        | string | `""`                                                                                                                                 | the username to login as. Note that this user needs permissions to query and generate cohorts                                                                                                                                                                                                                                                                                                                                                                      |
| query.webAPI.dataSource                           | string | `"CDS-CDMV5"`                                                                                                                        | name of the OMOP datasource used to generate the cohorts from.                                                                                                                                                                                                                                                                                                                                                                                                     |
| query.webAPI.url                                  | string | `"http://example:8080/WebAPI"`                                                                                                       | URL of the ATLAS WebAPI endpoint. Usually ends in /WebAPI.                                                                                                                                                                                                                                                                                                                                                                                                         |
| tests.resources                                   | object | `{}`                                                                                                                                 | configure the test pods resource requests and limits                                                                                                                                                                                                                                                                                                                                                                                                               |
| waitForPostgresInitContainer                      | object | `{}`                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

## Configure Notifcation Rules

The notification rules can be directly configured inside your values.yaml. For example:

```yaml
notify:
  enabled: true
  rules:
    # create custom notification schedules using https://www.cronmaker.com
    # these are later referenced used when configuring the notification frequency per user.
    # Note that the user will only receive an email notification if the scheduled time has been
    # reached _and_ there has been a _new_ patient recommendation since the last one.An identical
    # email won't be relentlessly sent everyMorning/Monday/Hour etc...
    schedules:
      everyMorning: "0 0 8 1/1 * ? *"
      everyMonday: "0 0 8 ? * MON *"
      everyHour: "0 0 0/1 1/1 * ? *"
      everyFiveMinutes: "0 0/5 * 1/1 * ? *"

    # trials are identified by their acronym which corresponds to the cohort's title in Atlas or the "[acronym=XYZ]" tag
    trials:
      # a value of '*' matches every trial, so 'everything@example.com' will receive an email whenever any screeninglist
      # gets updated.
      - acronym: "*"
        subscriptions:
          - email: "everything@example.com"

      - acronym: "SAMPLE"
        # the new "accessibleBy" key allows specifying users either by username or email address that
        # are allowed to access the screening list
        accessibleBy:
          users:
            - "user1"
            - "user.two@example.com"
        subscriptions:
          - email: "everyMorning@example.com"
            # each 'notify'-value corresponds to one schedule
            notify: "everyMorning"
            # a lack of a 'notify'-key with an associated schedule means that the user will be notified immediately.
          - email: "immediately-sample@example.com"
            # For example, the following entry means that if the 'SAMPLE' trial received new screening recommendations,
            # an email is sent to 'everyMonday@example.com' on the next monday. This is useful for aggregating notifications
            # about screening recommendations.
          - email: "everyMonday@example.com"
            notify: "everyMonday"

      - acronym: "AMICA"
        subscriptions:
          - email: "immediately-amica@example.com"
          - email: "everyHour1@example.com"
            notify: "everyHour"
          - email: "everyHour2@example.com"
            notify: "everyHour"
          - email: "everyFiveMinutes@example.com"
            notify: "everyFiveMinutes"
```

## Distributed Tracing

See the documentation on distributed tracing for more information: <https://miracum.github.io/recruit/deployment/kubernetes/#distributed-tracing>.
